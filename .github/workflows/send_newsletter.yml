name: Send Newsletter

on:
  schedule:
    - cron: '49 8 * * 6'
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  PYTHON_VERSION: '3.12'
  RECIPIENTS_REPO: kctong529/sisukas-newsletter-recipients

jobs:
  generate:
    name: Generate Newsletter
    runs-on: ubuntu-latest
    outputs:
      newsletter-path: newsletter.html
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Fetch existing courses.json if available
        run: |
          curl -fSL \
          "https://storage.googleapis.com/sisukas-core/courses.json" \
          -o courses.json

      - name: Generate newsletter HTML
        run: |
          python scripts/generate_newsletter.py courses.json -o newsletter.html

      - name: Upload newsletter artifact
        uses: actions/upload-artifact@v4
        with:
          name: newsletter-html
          path: newsletter.html

  send:
    name: Send Newsletter
    runs-on: ubuntu-latest
    needs: generate
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download generated newsletter
        uses: actions/download-artifact@v4
        with:
          name: newsletter-html
          path: .

      - name: Set up SSH for recipients repo
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.RECIPIENTS_DEPLOY_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Clone private recipients repo
        run: |
          git clone git@github.com:${{ env.RECIPIENTS_REPO }}.git

      - name: Move email list into expected location
        run: |
          cp sisukas-newsletter-recipients/email_list.txt email_list.txt

      - name: Send newsletter
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
        run: |
          chmod +x scripts/send_newsletter.sh
          ./scripts/send_newsletter.sh

  publish:
    name: Publish Newsletter to GCS
    runs-on: ubuntu-latest
    needs: generate
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download generated newsletter
        uses: actions/download-artifact@v4
        with:
          name: newsletter-html
          path: .

      - name: Wrap newsletter for public view
        run: |
          pip install beautifulsoup4
          python scripts/wrap_newsletter.py newsletter.html -o newsletter_wrapped.html

      - id: auth
        uses: google-github-actions/auth@v3
        with:
          project_id: 'sisukas-fastapi'
          workload_identity_provider: 'projects/969370446235/locations/global/workloadIdentityPools/github/providers/my-repo'
          service_account: 'github-actions-deployer@sisukas-fastapi.iam.gserviceaccount.com'

      - name: Install gcloud CLI (storage)
        run: |
          sudo apt-get update
          sudo apt-get install -y google-cloud-cli

      - name: Upload newsletter to GCS
        run: |
          gcloud storage cp \
            newsletter_wrapped.html \
            gs://sisukas-core/newsletter.html
