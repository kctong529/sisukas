name: Deploy Backend to Cloud Run

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      gcp_project_id:
        required: true
        type: string
      region:
        required: false
        type: string
        default: europe-north1
      backend_cloud_run_service:
        required: true
        type: string
      cors_origins:
        required: true
        type: string
      frontend_url:
        required: true
        type: string
      backend_url:
        required: true
        type: string

jobs:
  deploy_backend_dev:
    name: Deploy Backend (Dev)
    if: ${{ inputs.environment == 'test' }}
    runs-on: ubuntu-latest

    environment: 
      name: ${{ inputs.environment }}
      url: ${{ inputs.backend_url }}

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Read backend version
        id: backend_version
        working-directory: backend
        run: |
          echo "APP_VERSION=v$(node -p "require('./package.json').version")" >> $GITHUB_ENV
      
      - name: Compute build timestamp
        run: |
          echo "BUILD_TIME_ISO=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_ENV
      
      - name: Show build metadata
        run: |
          echo "APP_VERSION=$APP_VERSION"
          echo "BUILD_TIME_ISO=$BUILD_TIME_ISO"

      - id: auth
        name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/969370446235/locations/global/workloadIdentityPools/github/providers/my-repo'
          service_account: 'github-actions-deployer@sisukas-fastapi.iam.gserviceaccount.com'

      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ inputs.backend_cloud_run_service }}
          region: ${{ inputs.region }}
          project_id: ${{ inputs.gcp_project_id }}
          source: './backend/'
          allow-unauthenticated: true
          env_vars: |
            ENVIRONMENT=${{ inputs.environment }}
            SERVICE_NAME=sisukas-backend
            APP_VERSION=${{ env.APP_VERSION }}
            GIT_COMMIT_SHA=${{ github.sha }}
            BUILD_TIME_ISO=${{ env.BUILD_TIME_ISO }}
            FRONTEND_URL=${{ inputs.frontend_url }}
            BACKEND_URL=${{ inputs.backend_url }}
            BETTER_AUTH_URL=${{ inputs.frontend_url }}
            CORS_ORIGINS=${{ inputs.cors_origins }}
            BETTER_AUTH_SECRET=${{ secrets.BETTER_AUTH_SECRET }}
            RESEND_API_KEY=${{ secrets.RESEND_API_KEY }}
            DATABASE_URL=${{ secrets.DATABASE_TEST_URL }}
            ADMIN_USERNAME=${{ secrets.ADMIN_USERNAME }}
            ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}

      - name: Check Deployment Health
        run: |
          sleep 10
          curl -f ${{ inputs.backend_url }}/health || exit 1

  deploy_backend_prod:
    name: Deploy Backend (Prod)
    if: ${{ inputs.environment == 'production' }}
    runs-on: ubuntu-latest

    environment: 
      name: ${{ inputs.environment }}
      url: ${{ inputs.backend_url }}

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Read backend version
        id: backend_version
        working-directory: backend
        run: |
          echo "APP_VERSION=v$(node -p "require('./package.json').version")" >> $GITHUB_ENV
      
      - name: Compute build timestamp
        run: |
          echo "BUILD_TIME_ISO=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_ENV
      
      - name: Show build metadata
        run: |
          echo "APP_VERSION=$APP_VERSION"
          echo "BUILD_TIME_ISO=$BUILD_TIME_ISO"

      - id: auth
        name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/969370446235/locations/global/workloadIdentityPools/github/providers/my-repo'
          service_account: 'github-actions-deployer@sisukas-fastapi.iam.gserviceaccount.com'

      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ inputs.backend_cloud_run_service }}
          region: ${{ inputs.region }}
          project_id: ${{ inputs.gcp_project_id }}
          source: './backend/'
          allow-unauthenticated: true
          flags: '--min-instances=1'
          env_vars: |
            ENVIRONMENT=${{ inputs.environment }}
            SERVICE_NAME=sisukas-backend
            APP_VERSION=${{ env.APP_VERSION }}
            GIT_COMMIT_SHA=${{ github.sha }}
            BUILD_TIME_ISO=${{ env.BUILD_TIME_ISO }}
            FRONTEND_URL=${{ inputs.frontend_url }}
            BACKEND_URL=${{ inputs.backend_url }}
            BETTER_AUTH_URL=${{ inputs.frontend_url }}
            CORS_ORIGINS=${{ inputs.cors_origins }}
            BETTER_AUTH_SECRET=${{ secrets.BETTER_AUTH_SECRET }}
            RESEND_API_KEY=${{ secrets.RESEND_API_KEY }}
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            ADMIN_USERNAME=${{ secrets.ADMIN_USERNAME }}
            ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}

      - name: Check Deployment Health
        run: |
          sleep 10
          curl -f ${{ inputs.backend_url }}/health || exit 1
